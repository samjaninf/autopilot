#!/bin/sh
log() {
    echo "[INFO] $1"
}

generate() {
    SOURCE_FILE=$1
    DEST_FILE=$2
    
    cat $SOURCE_FILE | perl -p -e 's/\$\{([^}]+)\}/defined $ENV{$1} ? $ENV{$1} : $&/eg' > $DEST_FILE
}

PASSWORD=$(caddy hash-password --plaintext "$PROXY_MONITOR_PASSWORD")

log "Generating configuration files..."
sed -e "s~{PROXY_MONITOR_PASSWORD}~${PASSWORD}~" \
    -e "s~{PROXY_CERT_EMAIL}~${PROXY_CERT_EMAIL}~" \
    /autopilot/conf/Caddyfile > /etc/caddy/Caddyfile

exec "$@"